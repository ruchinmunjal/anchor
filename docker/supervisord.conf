[supervisord]
nodaemon=true
user=root
logfile=/dev/stdout
logfile_maxbytes=0
pidfile=/var/run/supervisord.pid
loglevel=warn

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

; API - NestJS backend
[program:api]
command=/usr/local/bin/node /app/server/dist/src/main
directory=/app/server
priority=10
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
startsecs=5
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=PORT="3001",DATABASE_URL="%(ENV_DATABASE_URL)s",JWT_SECRET="%(ENV_JWT_SECRET)s",NODE_ENV="production",OIDC_ENABLED="%(ENV_OIDC_ENABLED)s",OIDC_PROVIDER_NAME="%(ENV_OIDC_PROVIDER_NAME)s",OIDC_ISSUER_URL="%(ENV_OIDC_ISSUER_URL)s",OIDC_CLIENT_ID="%(ENV_OIDC_CLIENT_ID)s",OIDC_CLIENT_SECRET="%(ENV_OIDC_CLIENT_SECRET)s",DISABLE_INTERNAL_AUTH="%(ENV_DISABLE_INTERNAL_AUTH)s",APP_URL="%(ENV_APP_URL)s"

; Web - Next.js frontend
[program:web]
command=/bin/sh -c "until curl -fsS http://127.0.0.1:3001/api/health >/dev/null 2>&1; do sleep 1; done; exec /usr/local/bin/node /app/web/server.js"
directory=/app/web
priority=20
autostart=true
autorestart=true
stopasgroup=true
killasgroup=true
startsecs=10
startretries=3
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
environment=PORT="3000",HOSTNAME="0.0.0.0",SERVER_URL="http://127.0.0.1:3001",NODE_ENV="production"